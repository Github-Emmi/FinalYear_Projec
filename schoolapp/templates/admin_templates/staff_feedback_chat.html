{% extends 'admin_templates/base.html' %}
{% load static %}

{% block title %}Staff Feedback{% endblock %}
{% block dashboard_title %}Staff Feedback{% endblock %}
{% block dashboard_title1 %}Feedback Conversation{% endblock %}

{% block main_content %}
<div class="row">
    <!-- Left: Staff List -->
    <div class="col-md-3">
        <div class="card card-outline card-primary">
            <div class="card-header">
                <h3 class="card-title">Staff</h3>
            </div>
            <div class="card-body p-0">
                <ul class="nav nav-pills flex-column">
                    {% for staff in staff_list %}
                        <li class="nav-item">
                            <a href="{% url 'staff_feedback_chat' staff.id %}"
                               class="nav-link {% if selected_staff and staff.id == selected_staff.id %}active{% endif %}">
                                {{ staff.admin.get_full_name }}
                            </a>
                        </li>
                    {% empty %}
                        <li class="nav-item text-center p-3 text-muted">
                            No Recent feedback from Staff
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Right: Chat Box -->
    <div class="col-md-9">
        <div class="card card-outline card-primary">
            <div class="card-header">
                <h3 class="card-title">
                    Conversation with {{ selected_staff.admin.get_full_name }}
                </h3>
            </div>
            <div class="card-body" id="chat-box" style="height: 350px; overflow-y: auto;">
                {% if no_feedback_message %}
                    <div class="text-center text-muted mt-4">{{ no_feedback_message }}</div>
                {% else %}
                    {% for msg in messages %}
                        {% if msg.feedback %}
                            <div class="mb-2">
                                <span class="badge badge-primary">Staff:</span>
                                {{ msg.feedback }}
                                <div class="text-muted small">{{ msg.created_at }}</div>
                            </div>
                        {% endif %}
                        {% if msg.feedback_reply %}
                            <div class="mb-2 text-right">
                                <span class="badge badge-secondary">Admin:</span>
                                {{ msg.feedback_reply }}
                                <div class="text-muted small">{{ msg.updated_at }}</div>
                            </div>
                        {% endif %}
                    {% empty %}
                        <div class="text-center text-muted mt-4">
                            No messages yet with {{ selected_staff.admin.get_full_name }}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
            <div class="card-footer">
                <div class="input-group">
                    <input type="text" id="reply-message" class="form-control" placeholder="Type your message...">
                    <div class="input-group-append">
                        <button id="send-reply" class="btn btn-primary">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById("send-reply").addEventListener("click", function() {
    const msg = document.getElementById("reply-message").value;
    if (!msg.trim()) return;

    fetch("{% url 'staff_feedback_reply_ajax' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `staff_id={{ selected_staff.id }}&message=${encodeURIComponent(msg)}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") {
            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML += `
                <div class="mb-2 text-right">
                    <span class="badge badge-secondary">Admin:</span>
                    ${msg}
                    <div class="text-muted small">${data.created_at}</div>
                </div>
            `;
            document.getElementById("reply-message").value = "";
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    });
});
</script>
{% endblock %}
