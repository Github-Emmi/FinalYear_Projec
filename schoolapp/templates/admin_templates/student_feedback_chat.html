{% extends 'admin_templates/base.html' %}
{% load static %}

{% block title %}Student Feedback{% endblock %}

{% block Stylesheet %}
<style>
/* Chat area */
#chat-body {
  max-height: 60vh;
  overflow-y: auto;
  background: #f8f9fa;
  padding: 1rem;
}

/* Bubbles */
.chat-bubble {
  position: relative;
  padding: 10px 14px;
  border-radius: 22px;
  max-width: 75%;
  line-height: 1.45;
  word-break: break-word;
}

.chat-bubble-right {
  background: #0d6efd; /* AdminLTE primary blue */
  color: #fff;
  border-bottom-right-radius: 8px;
}
.chat-bubble-right::after {
  content: "";
  position: absolute;
  right: -10px;
  top: 16px;
  border-width: 10px 0 10px 10px;
  border-style: solid;
  border-color: transparent transparent transparent #0d6efd;
}

.chat-bubble-left {
  background: #eef1f6;
  color: #0b1e39;
  border-bottom-left-radius: 8px;
}
.chat-bubble-left::after {
  content: "";
  position: absolute;
  left: -10px;
  top: 16px;
  border-width: 10px 10px 10px 0;
  border-style: solid;
  border-color: transparent #eef1f6 transparent transparent;
}

/* Avatars */
.chat-avatar {
  width: 38px; height: 38px;
  border-radius: 50%;
  object-fit: cover;
}

/* Timestamps */
.chat-time {
  font-size: .75rem;
  color: #6c757d;
}

/* Composer */
#composer .input-group > .form-control {
  border-top-left-radius: 999px;
  border-bottom-left-radius: 999px;
}
#composer .input-group-append .btn {
  border-top-right-radius: 999px;
  border-bottom-right-radius: 999px;
}
</style>
{% endblock Stylesheet %}

{% block dashboard_title %}Student Feedback{% endblock %}
{% block dashboard_title1 %}Feedback Conversation{% endblock %}

{% block main_content %}
<div class="row">

    <!-- Left: Student List -->
    <div class="col-md-3">
        <div class="card card-outline card-primary">
            <div class="card-header">
                <h3 class="card-title">Students</h3>
            </div>
            <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                <ul class="nav nav-pills flex-column">
                    {% for student in student_list %}
                        <li class="nav-item">
                            <a href="#" data-student="{{ student.id }}"
                               class="nav-link {% if selected_student and student.id == selected_student.id %}active{% endif %}">
                                {{ student.admin.get_full_name }}
                            </a>
                        </li>
                    {% empty %}
                        <li class="nav-item text-center p-3 text-muted">
                            No Recent feedback from Students
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Right: Chat Box -->
    <div class="col-md-9">
        <div class="card card-outline card-primary" id="chat-container">
            {% include 'admin_templates/student_chat_box.html' with messages=messages selected_student=selected_student %}
        </div>
    </div>

</div>

<script>
function bindChatLinks() {
    document.querySelectorAll("[data-student]").forEach(link => {
        link.addEventListener("click", function(e) {
            e.preventDefault();
            const studentId = this.getAttribute("data-student");

            fetch(`/student-feedback/chat/${studentId}/`)
              .then(res => res.json())
              .then(data => {
                if (data.status === "success") {
                  document.getElementById("chat-container").innerHTML = data.html;
                  bindSendReply();
                }
              });
        });
    });
}

function bindSendReply() {
    const sendBtn = document.getElementById("send-reply");
    if (!sendBtn) return;

    sendBtn.addEventListener("click", function() {
        const msg = document.getElementById("reply-message").value;
        const studentId = this.dataset.student;
        if (!msg.trim()) return;

        fetch("{% url 'student_feedback_reply_ajax' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `student_id=${studentId}&message=${encodeURIComponent(msg)}`
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                const chatBox = document.getElementById("chat-box");
                chatBox.innerHTML += `
                  <div class="d-flex justify-content-end mb-3">
                    <div class="text-right">
                      <div class="chat-time">${data.created_at}</div>
                      <div class="d-flex align-items-end">
                        <div class="chat-bubble chat-bubble-right mr-2">${msg}</div>
                        <img src="{{ admin_avatar_url }}" class="chat-avatar">
                      </div>
                    </div>
                  </div>`;
                document.getElementById("reply-message").value = "";
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        });
    });
}

// bind on first load
bindChatLinks();
bindSendReply();
</script>
{% endblock %}
