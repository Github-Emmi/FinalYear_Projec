{% comment %} Only the right chat panel body + composer. {% endcomment %}
<div class="card card-primary card-outline mb-3">
  <div class="card-header">
    <h3 class="card-title mb-0">
      {% if selected_student %}
        Chat with {{ selected_student.admin.get_full_name|default:selected_student.admin.username }}
      {% else %}
        No conversation
      {% endif %}
    </h3>
  </div>

  <div id="chat-body" class="card-body" style="max-height:60vh;overflow-y:auto;background:#f8f9fa;padding:1rem;">
    {% if selected_student %}
      {% for msg in messages %}
        {% if msg.feedback %}
          <!-- Student bubble (left) -->
          <div class="d-flex justify-content-start mb-3">
            <img class="rounded-circle mr-2" style="width:38px;height:38px;object-fit:cover;"
                 src="{% if selected_student.admin.profile_pic %}{{ selected_student.admin.profile_pic.url }}{% else %}/static/assets/images/student_avatar.png{% endif %}"
                 alt="Student">
            <div>
              <div class="text-muted small mb-1">{{ msg.created_at|date:"M d, g:i a" }}</div>
              <div class="chat-bubble chat-bubble-left">{{ msg.feedback }}</div>
            </div>
          </div>
        {% endif %}

        {% if msg.feedback_reply %}
          <!-- Admin bubble (right) -->
          <div class="d-flex justify-content-end mb-3">
            <div class="text-right">
              <div class="text-muted small mb-1">{{ msg.created_at|date:"M d, g:i a" }}</div>
              <div class="d-flex align-items-end">
                <div class="chat-bubble chat-bubble-right mr-2">{{ msg.feedback_reply }}</div>
                <img class="rounded-circle" style="width:38px;height:38px;object-fit:cover;"
                     src="{{ admin_avatar_url }}" alt="Admin">
              </div>
            </div>
          </div>
        {% endif %}
      {% empty %}
        <p class="text-muted text-center my-4">No messages yet. Start a conversation below.</p>
      {% endfor %}
    {% else %}
      <p class="text-muted text-center my-4">No recent feedback from students.</p>
    {% endif %}
  </div>

  {% if selected_student %}
  <div class="card-footer">
    <form id="send-form" action="{% url 'admin_student_feedback_send' %}" method="post" autocomplete="off">
      {% csrf_token %}
      <input type="hidden" name="student_id" id="student-id" value="{{ selected_student.id }}">
      <div class="input-group">
        <input id="msg-input" name="message" type="text" class="form-control" placeholder="Type your messageâ€¦" maxlength="1000">
        <div class="input-group-append">
          <button id="send-btn" class="btn btn-primary" type="submit">
            <i class="fas fa-paper-plane"></i> Send
          </button>
        </div>
      </div>
    </form>
  </div>
  {% endif %}
</div>
